<!-- <!DOCTYPE html>
<html>
<head>
  <title>Computer Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    #qr-code { margin: 1rem auto; display: block; }
    .value { font-size: 1.5rem; margin: 1rem; }
    #countdown, #startBtn, #stopBtn { margin-top: 1.5rem; font-size: 1.2rem; }
    button { padding: 0.5rem 1rem; font-size: 1rem; margin: 0.5rem; }
  </style>
</head>
<body>

  <h1>ðŸ’» Waiting for Phone Connection</h1>
  <div id="peer-id">Generating peer ID...</div>
  <canvas id="qr-code"></canvas>

  <div class="value">X: <span id="x">-</span></div>
  <div class="value">Y: <span id="y">-</span></div>
  <div class="value">Z: <span id="z">-</span></div>
  <div class="value">Magnitude: <span id="mag">-</span></div>

  <button id="startBtn" onclick="startCountdown()" disabled>Start Recording</button>
  <button id="stopBtn" onclick="stopRecording()" disabled>Stop</button>

  <h2 id="countdown"></h2>

  <script>
    const peer = new Peer();
    let conn;
    let recording = false;
    let recordedData = [];

    peer.on('open', id => {
      document.getElementById('peer-id').textContent = `Your Peer ID: ${id}`;
      const url = `https://fyrebolt.github.io/lahacks3/stream.html?id=${id}`;
      QRCode.toCanvas(document.getElementById('qr-code'), url);
    });

    peer.on('connection', connection => {
      conn = connection;
      document.querySelector('canvas').style.display = 'none';
      document.getElementById('peer-id').textContent = 'Phone Connected âœ…';
      document.getElementById('startBtn').disabled = false;

      conn.on('data', data => {
        const x = data.x.toFixed(2);
        const y = data.y.toFixed(2);
        const z = data.z.toFixed(2);
        const mag = Math.sqrt(data.x ** 2 + data.y ** 2 + data.z ** 2).toFixed(2);
        document.getElementById('x').textContent = x;
        document.getElementById('y').textContent = y;
        document.getElementById('z').textContent = z;
        document.getElementById('mag').textContent = mag;

        if (recording) {
          recordedData.push({ x: +x, y: +y, z: +z, mag: +mag, time: Date.now() });
        }
      });
    });

    function startCountdown() {
      document.getElementById('startBtn').disabled = true;
      let count = 3;
      document.getElementById('countdown').textContent = `Starting in ${count}...`;
      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          document.getElementById('countdown').textContent = `Starting in ${count}...`;
        } else {
          clearInterval(interval);
          recording = true;
          document.getElementById('countdown').textContent = 'Recording...';
          document.getElementById('stopBtn').disabled = false;
        }
      }, 1000);
    }

    function stopRecording() {
      recording = false;
      document.getElementById('countdown').textContent = 'Recording stopped.';
      document.getElementById('stopBtn').disabled = true;
      console.log('Recorded data:', recordedData);
    }
  </script>

</body>
</html>
 -->

 <!DOCTYPE html>
<html>
<head>
  <title>Computer Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    #qr-code { margin: 1rem auto; display: block; }
    .value { font-size: 1.5rem; margin: 1rem; }
    #countdown, #startBtn, #stopBtn { margin-top: 1.5rem; font-size: 1.2rem; }
    button { padding: 0.5rem 1rem; font-size: 1rem; margin: 0.5rem; }
  </style>
</head>
<body>

  <h1>ðŸ’» Waiting for Phone Connection</h1>
  <div id="peer-id">Generating peer ID...</div>
  <canvas id="qr-code"></canvas>

  <div class="value">X: <span id="x">-</span></div>
  <div class="value">Y: <span id="y">-</span></div>
  <div class="value">Z: <span id="z">-</span></div>
  <div class="value">Magnitude: <span id="mag">-</span></div>
  
  <div class="value">Velocity: <span id="vel">0.00</span> m/s</div>
  <div class="value"> first Displacement: <span id="disp">0.00</span> m</div>
  <div class="value"> Other Displacement: <span id="other">0.00</span> m</div>

  <button id="startBtn" onclick="startCountdown()" disabled>Start Recording</button>
  <button id="stopBtn" onclick="stopRecording()" disabled>Stop</button>

  <h2 id="countdown"></h2>

  <script>
    const peer = new Peer();
    let conn;
    let recording = false;
    let recordedData = [];

    // Motion state
    let velocity = { x: 0, y: 0, z: 0 };
    let velM = 0;
    let displacement = { x: 0, y: 0, z: 0 };
    let lastTimestamp = null;

    let otherDisp = 0;

    peer.on('open', id => {
      document.getElementById('peer-id').textContent = `Your Peer ID: ${id}`;
      const url = `https://fyrebolt.github.io/lahacks3/stream.html?id=${id}`;
      QRCode.toCanvas(document.getElementById('qr-code'), url);
    });

    peer.on('connection', connection => {
      conn = connection;
      document.querySelector('canvas').style.display = 'none';
      document.getElementById('peer-id').textContent = 'Phone Connected âœ…';
      document.getElementById('startBtn').disabled = false;

      conn.on('data', data => {
        const now = Date.now();

        let x = data.x.toFixed(2);
        let y = data.y.toFixed(2);
        let z = data.z.toFixed(2);

        if (Math.abs(x) < 0.08) {
          x = 0;
        }

        if (Math.abs(y) < 0.08) {
          y = 0;
        }

        if (Math.abs(z) < 0.08) {
          z = 0;
        }

        
        const mag = Math.sqrt(x ** 2 + y ** 2 + z ** 2).toFixed(2);
        
        document.getElementById('x').textContent = x;
        document.getElementById('y').textContent = y;
        document.getElementById('z').textContent = z;
        document.getElementById('mag').textContent = mag;
        
        // Integrate acceleration to velocity and displacement
        if (lastTimestamp !== null) {
          const dt = (now - lastTimestamp) / 1000; // convert ms to seconds

          if (Math.abs(data.x) < 0.05 && Math.abs(data.y) < 0.05 && Math.abs(data.z) < 0.05) {
            velocity = { x: 0, y: 0, z: 0 };
          }
          
          velocity.x += x * dt;
          velocity.y += y * dt;
          velocity.z += z * dt;

          displacement.x += velocity.x * dt;
          displacement.y += velocity.y * dt;
          displacement.z += velocity.z * dt;

          const totalVel = Math.sqrt(
            velocity.x ** 2 +
            velocity.y ** 2 +
            velocity.z ** 2
          );
          
          const totalDisp = Math.sqrt(
            displacement.x ** 2 +
            displacement.y ** 2 +
            displacement.z ** 2
          );

          otherDisp += (mag) * (dt ** 2);
          // velM += mag * dt;
          // totalDisp += velM * dt;

          document.getElementById('vel').textContent = totalVel.toFixed(2);
          document.getElementById('disp').textContent = totalDisp.toFixed(2);
          document.getElementById('other').textContent = otherDisp.toFixed(2);
        }

        lastTimestamp = now;

        if (recording) {
          recordedData.push({
            x: +x, y: +y, z: +z, mag: +mag,
            time: now
          });
        }
      });
    });

    function startCountdown() {
      document.getElementById('startBtn').disabled = true;
      let count = 3;
      document.getElementById('countdown').textContent = `Starting in ${count}...`;
      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          document.getElementById('countdown').textContent = `Starting in ${count}...`;
        } else {
          clearInterval(interval);
          recording = true;
          document.getElementById('countdown').textContent = 'Recording...';
          document.getElementById('stopBtn').disabled = false;
        }
      }, 1000);
    }

    function stopRecording() {
      recording = false;
      document.getElementById('countdown').textContent = 'Recording stopped.';
      document.getElementById('stopBtn').disabled = true;
      console.log('Recorded data:', recordedData);
    }
  </script>

</body>
</html>
